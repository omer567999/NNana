router.post("/login", loginController);
/* ğŸ‘€ soft delete veri durur gizlenir /hard delete DB den silinir gelmez KullanÄ±cÄ± yanlÄ±ÅŸlÄ±kla siler MÃ¼ÅŸteri â€œgeri alâ€ derAudit / log gerekir  */
/*  modele ekleme*/
const userSchema = new mongoose.Schema({
  email: String,
  password: String,
  isDeleted: {
    type: Boolean,
    default: false
  }
});
/*  getlerde filtreleme yapÄ±lmasa soft delete bos*/
const users = await User.find({ isDeleted: false });
/* delete endonpint  silindi sanÄ±lÄ±r ama DB dedir*/
exports.deleteUser = async (req, res) => {
  await User.findByIdAndUpdate(req.params.id, {
    isDeleted: true
  });

  res.json({ message: "User deleted" });
};
/* admin iÃ§in geri alma ÅŸaÅŸ admin paneli mantik*/
exports.restoreUser,isDeleted: false,({ message: "User restored".
/* tarihle soft delete audith log*/
deletedAt: {
  type: Date,
  default: null
}
/*  */
deletedAt: new Date()
/*  */
/* Enum izin verilen roller email pasword role{ */
/* auth mildwareJWTâ€™den user info geliyorrole kontrol */
req.user = {
  userId: decoded.id,
  role: decoded.role
};
/*routa gerÃ§ek kulanim  sadece admin girebilir*/
router.delete(
  "/users/:id",
  auth,
  roleCheck(["admin"]),
  deleteUser
);
/* hem admin hem user girebilir */
router.get(
  "/profile",
  auth,
  roleCheck(["admin", "user"]),
  getProfile
);
/* kontroller temiz kalir ğŸ“Œ Yetki kontrolÃ¼ routeâ€™taontroller sade*/
exports.deleteUser = async (req, res) => {
  res.json({ message: "User deleted" });
};
/* role check mildware reusuble tekrar kulanilir */
const roleCheck = (roles) => {
  return (req, res, next) => {
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({
        message: "Access denied"
      });
    }
    next();
  };
};

module.exports = roleCheck;
/*  background jobs arka plan iÅŸleri Email gÃ¶nderme (register, reset password)
ğŸ”” NotificationğŸ“„ PDF / invoice oluÅŸturmağŸ–¼ï¸ Image resizeğŸ§¹ Eski kayÄ±t temizlemeğŸ“Š Rapor oluÅŸturma  */
/* Queue iÅŸler sirayla,worker arkada Ã§aliÅŸir */
API (Express),Queue (Redis),Worke,rEmail / PDF / Notification
/* GERÃ‡EK Ã–RNEK: REGISTER + EMAIL
Senaryo:KullanÄ±cÄ± kayÄ±t olduâ€œHoÅŸ geldinâ€ maili gidecekAma API beklemeyecek */
/* Queue oluÅŸturma gerÃ§ak prod //queus/emai.qoueu */
const Queue = repuied("bull");

const QoueuEmail = new Queue("QeueEmail");
module.export = QueueEmail;
/* controler  job ekleme api aninda cevap verir mail arkada gider */
const emailQueue = rephuied(".../queues/emails.queue");
export.register = async (req,res)=> {
/* user db ye kaydedildi varsayilan */
    await emailQueue.add({
        email:req.body.email,
        type"welcome"
    });
    res.status(201).json({mesage:"user crated"});
};
/* //workers/email.worker.js api deÄŸil ayri podcess  */
const emailQueue = repuied(".../queus/email.queue");
emailQueue.process(async(job)=>{
    const {email,type} = job.data;
    if(type === "welcome") {
        console.log("sanding welcome to email ${email}");
    }
});
/*gerÃ§ek projede nodemailer//provider */
/*cacheng redis Prodâ€™da Redis ayrÄ± servis olur MantÄ±k deÄŸiÅŸmez /// */
const redis = require("redis");

const redisClient = redis.createClient();

redisClient.connect();

module.exports = redisClient;

/*  endpoint 50.000 Ã¼rÃ¼n
Her kullanÄ±cÄ± sayfa yeniliyor Her seferinde DB legidiliyor*/
GET /products
/* redis olmadan  Her istek â†’ DB 1000 kullanÄ±cÄ± â†’ 1000 DB sorgusu*/
exports.getProducts = async (req, res) => {
  const products = await Product.find();
  res.json(products);
};
/* prod Ã§Ã¶zÃ¼m mantÄ±k  */
Ä°stek gelir
â†“Redis'te var mÄ±? EVET â†’ Redis'ten dÃ¶nHAYIR â†’ DB â†’ Redis'e yaz â†’ dÃ¶n
/* cache temizleme Ã¼rÃ¼n eklendi silindi cache geÃ§ici veri deÄŸiÅŸince silinir */
await redisClient.del("products:all");
/* cacheli kontroller  Ä°lk istek â†’ DB Sonraki 60 saniye â†’ Redis DB rahatlar*/
const redisClient = require("../config/redis");

exports.getProducts = async (req, res) => {
  const cacheKey = "products:all";

  const cachedData = await redisClient.get(cacheKey);

  if (cachedData) {
    return res.json(JSON.parse(cachedData));
  }

  const products = await Product.find();

  await redisClient.setEx(
    cacheKey,
    60, // 60 saniye
    JSON.stringify(products)
  );

  res.json(products);
};
/*hata ne zaman oldu kim yapti logging hangi endonpint  */
WÄ°NSTON/PÄ°NO
/*DATABESE CHECK index warmi pagination varmi  */
.FÄ°ND()
.limit(20)
.skip(page*20)
/* backend depolay  cloud port verir uyulmasi zorunda */
app.listen(process.env.Port);
/*  PANELDEN GÄ°RÄ°LÄ°R CLOUDA KOD GÃ–RMEZ ENV GÃ–RÃœR*/
env.
MONGO_URÄ°=
JWT_SECRET=
REDÄ°S_URL
/* DEBOLAY PLATFORM MANTÄ°ÄÄ° RENDER RAÄ°LWY GÄ°THUBA BAÄLANÄ°R npm instal npm start dÃ¼zgÃ¼nse eÄŸer yazi*/
"scripts":{
    "start":"node js.server"
}
/* producton hatalari nasil gÃ¶rÃ¼nÃ¼r stack trace kulaniciya gitmez log panelde gÃ¶rÃ¼nÃ¼r */
console.error(err)
/* heath check cloud bunu kulanir ayaktami Ã§Ã¶ktÃ¼mÃ¼ */
app.get("/heath",(req,res) => {
    res.json({status:"ok"});
});
/* proud kalan konuyar//versingong = client bozulmaz  */
/api/vi/users,/api/v2/users /* ratelyimitdede "/api"var */
/* gracehul shotdown depolay sirasinda repuest yarim kalmaz producton inceliÄŸi */
process.on("SEGTREM", ()=>{
    server.close( ()=>{
        console.log("server kapandi");
    });
});
BACKUP STRATEJÄ°SÄ° (HAYAT KURTARIR)
GerÃ§ek:
DB silinir
Hata olur
Ä°nsan hatasÄ± olur
Productionâ€™da:
Mongo Atlas â†’ otomatik backup
Render / Railway â†’ DB ayrÄ± tutulur
ğŸ“Œ Senin bilmen gereken:
â€œDB backupâ€™Ä± platform saÄŸlar, ben farkÄ±nda olurum.â€
/*  */


